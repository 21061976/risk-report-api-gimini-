<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiskReportAI - מחולל דוחות ניהול סיכונים חכם</title>
    <style>
        /* Reset and Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2c3e50;
            min-height: 100vh;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active { display: flex; }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Platform Styles */
        .platform-container {
            max-width: 900px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .platform-header { text-align: center; margin-bottom: 40px; }
        .platform-header h1 { font-size: 2.8em; color: #2c3e50; margin-bottom: 10px; }
        .platform-header .subtitle { font-size: 1.3em; color: #7f8c8d; margin-bottom: 30px; }

        /* API Key Setup */
        .api-setup {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #4285f4;
            margin-bottom: 30px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .api-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: monospace;
        }

        .api-input:focus {
            border-color: #4285f4;
            outline: none;
        }

        .api-button {
            padding: 12px 25px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .api-button:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }

        .api-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed #4285f4;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
            display: none;
        }

        .upload-zone.active { display: block; }

        .upload-zone:hover { 
            border-color: #3367d6; 
            background: rgba(66, 133, 244, 0.05); 
            transform: translateY(-5px); 
        }
        
        .upload-zone.dragover {
            border-color: #34a853;
            background: rgba(52, 168, 83, 0.1);
            transform: scale(1.02);
        }

        .upload-icon { font-size: 4em; color: #4285f4; margin-bottom: 20px; }
        .upload-title { font-size: 2em; color: #2c3e50; margin-bottom: 15px; font-weight: bold; }
        .upload-subtitle { font-size: 1.1em; color: #7f8c8d; margin-bottom: 30px; }

        .upload-button {
            background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
        }

        /* Processing Styles */
        .processing-container { text-align: center; display: none; }
        .processing-container.active { display: block; }
        .file-info { 
            background: #e8f8f5; 
            padding: 15px; 
            border-radius: 10px; 
            border-left: 4px solid #34a853; 
            margin-bottom: 30px; 
            text-align: right;
        }
        
        .progress-bar { 
            width: 100%; 
            height: 12px; 
            background: #ecf0f1; 
            border-radius: 6px; 
            overflow: hidden; 
            margin-bottom: 20px; 
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #4285f4, #34a853); 
            width: 0%; 
            transition: width 0.8s ease; 
        }

        .processing-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .step { text-align: center; opacity: 0.5; transition: all 0.3s ease; }
        .step.active { opacity: 1; }
        .step.current { opacity: 1; transform: scale(1.05); }

        .step-number {
            width: 50px; height: 50px; border-radius: 50%; background: #bdc3c7; color: white;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;
            font-weight: bold; font-size: 1.2em;
        }

        .step.active .step-number { background: #4285f4; }
        .step.current .step-number { background: #34a853; animation: pulse 1.5s infinite; }

        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.1); } 
            100% { transform: scale(1); } 
        }

        /* Control Buttons */
        .control-buttons { 
            position: fixed; 
            top: 20px; 
            left: 20px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        .control-btn { 
            padding: 15px 25px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: bold; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .new-report-btn { background: #95a5a6; color: white; }
        .edit-toggle { background: #4285f4; color: white; }
        .edit-toggle.active { background: #34a853; }
        .pdf-export { background: #ea4335; color: white; }
        .pdf-export.exporting { background: #fbbc04; cursor: not-allowed; }
        .control-btn:hover { transform: translateY(-2px); }

        /* Success Message */
        .success-message {
            position: fixed; 
            top: 100px; 
            right: 20px; 
            background: #34a853; 
            color: white;
            padding: 15px 25px; 
            border-radius: 10px; 
            font-weight: bold; 
            opacity: 0;
            transform: translateX(400px); 
            transition: all 0.3s ease; 
            z-index: 1001;
            max-width: 350px; 
            white-space: pre-line;
        }
        .success-message.show { opacity: 1; transform: translateX(0); }

        /* Report Container - EXACTLY MATCHING ORIGINAL */
        .report-container { 
            display: none; 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.98); 
            border-radius: 20px; 
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); 
            overflow: hidden; 
        }
        .report-container.active { display: block; }

        /* === EXACT COPY OF ORIGINAL REPORT STYLES === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.4em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            margin-bottom: 10px;
        }

        .date-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 15px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        /* Navigation Menu */
        .nav-menu {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .nav-links {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            list-style: none;
            margin: 0;
        }

        .nav-links li {
            flex: 1;
        }

        .nav-links a {
            display: block;
            padding: 18px 20px;
            color: #bdc3c7;
            text-decoration: none;
            text-align: center;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            border-left: 1px solid #2c3e50;
            position: relative;
        }

        .nav-links li:first-child a {
            border-left: none;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: #2c3e50;
            color: white;
            transform: translateY(-2px);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: #4285f4;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            width: 80%;
        }

        /* Sections */
        .section {
            scroll-margin-top: 80px;
        }

        .section-header {
            background: linear-gradient(135deg, #ea4335 0%, #c23321 100%);
            color: white;
            padding: 25px 40px;
            font-size: 2.2em;
            font-weight: bold;
            text-align: center;
            margin: 0;
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 5px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
        }

        .project-overview {
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .overview-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #4285f4;
            transition: all 0.3s ease;
        }

        .overview-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
        }

        .overview-card h4 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overview-card .icon {
            font-size: 1.5em;
        }

        .goals-section {
            background: white;
            margin: 30px 40px;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .goals-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }

        .goal-item, .deliverable-item {
            background: #f8f9fa;
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            border-right: 4px solid #34a853;
            transition: all 0.3s ease;
        }

        .goal-item:hover, .deliverable-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        .risks-container {
            padding: 40px;
            background: white;
        }

        .risk-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .very-high { color: #ea4335; }
        .high { color: #fbbc04; }
        .medium { color: #f9ab00; }
        .low { color: #34a853; }

        .risks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .risk-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            transition: all 0.3s ease;
            border-top: 6px solid;
            position: relative;
            overflow: hidden;
        }

        .risk-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .risk-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .risk-very-high { border-top-color: #ea4335; }
        .risk-high { border-top-color: #fbbc04; }
        .risk-medium { border-top-color: #f9ab00; }
        .risk-low { border-top-color: #34a853; }

        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 15px;
        }

        .risk-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            flex: 1;
        }

        .risk-severity {
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            white-space: nowrap;
        }

        .severity-very-high { background: #ea4335; }
        .severity-high { background: #fbbc04; }
        .severity-medium { background: #f9ab00; color: #2c3e50; }
        .severity-low { background: #34a853; }

        .risk-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .risk-description, .risk-opportunity {
            color: #34495e;
            line-height: 1.7;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-right: 4px solid #bdc3c7;
        }

        .risk-opportunity {
            border-right-color: #34a853;
            margin-top: 10px;
        }
        
        .risk-impact {
            margin-top: 20px;
        }

        .impact-title {
            font-weight: bold;
            color: #ea4335;
            margin-bottom: 10px;
        }

        .impact-list {
            list-style: none;
            padding-right: 15px;
        }

        .impact-list li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
        }

        .impact-list li::before {
            content: '⚠️';
            margin-left: 10px;
        }

        .opportunity-title {
            font-weight: bold;
            color: #34a853;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .opportunity-list {
            list-style: none;
            padding-right: 15px;
        }

        .opportunity-list li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
        }

        .opportunity-list li::before {
            content: '✅';
            margin-left: 10px;
        }

        .strategies-section {
            padding: 50px 40px;
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
        }

        .strategy-card {
            background: white;
            margin: 30px 0;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .strategy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .strategy-header {
            background: linear-gradient(135deg, #34a853 0%, #1e7e34 100%);
            color: white;
            padding: 25px 30px;
            font-weight: bold;
            font-size: 1.3em;
            position: relative;
        }

        .strategy-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 30px;
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
        }

        .strategy-content {
            padding: 30px;
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .strategy-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .strategy-item, .detail-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-right: 4px solid #34a853;
            transition: all 0.3s ease;
        }

        .strategy-item:hover, .detail-item:hover {
            background: #e9ecef;
            transform: translateX(-3px);
        }

        .strategy-item h5, .detail-item h5 {
            color: #34a853;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .timeline-badge {
            display: inline-block;
            background: #4285f4;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .summary-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .committee-recommendations {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 6px solid #4285f4;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .committee-recommendations h4 {
            color: #34495e;
            font-size: 1.4em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .committee-recommendations .editable {
            font-size: 1.1em;
            line-height: 1.8;
            color: #555;
        }

        .innovation-section {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
            position: relative;
        }

        .innovation-score {
            font-size: 5em;
            font-weight: bold;
            margin: 30px 0;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .innovation-components {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .component-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .component-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .component-score {
            font-size: 2.5em;
            font-weight: bold;
            color: #fbbc04;
            margin-bottom: 10px;
        }

        .component-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .regulation-section {
            padding: 40px;
            background: #ecf0f1;
        }

        .regulation-table {
            width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            margin: 20px 0;
        }

        .regulation-table th,
        .regulation-table td {
            padding: 20px;
            text-align: right;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top;
        }

        .regulation-table th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        .regulation-table tr:hover {
            background: #f8f9fa;
        }

        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 30px;
            font-size: 0.9em;
        }

        /* Editable Styles */
        .editable {
            padding: 3px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .editable[contenteditable="true"] {
            background: rgba(66, 133, 244, 0.1);
            border: 2px dashed #4285f4;
            outline: none;
            cursor: text;
            padding: 5px;
        }

        .editable[contenteditable="true"]:hover {
            background: rgba(66, 133, 244, 0.2);
        }

        .editable[contenteditable="true"]:focus {
            background: rgba(66, 133, 244, 0.15);
            box-shadow: 0 0 10px rgba(66, 133, 244, 0.5);
        }

        /* Gemini Badge */
        .gemini-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 50%, #fbbc04 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: bold;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .platform-container { margin: 10px; padding: 20px; }
            .upload-zone { padding: 40px 20px; }
            .processing-steps { grid-template-columns: 1fr; }
            
            .control-buttons { 
                position: relative; 
                top: auto; 
                left: auto; 
                flex-direction: row; 
                justify-content: center; 
                margin-bottom: 20px; 
                flex-wrap: wrap;
            }
            
            .header h1 { font-size: 2.2em; }
            .nav-links { flex-direction: column; }
            .nav-links a { border-left: none; border-bottom: 1px solid #2c3e50; }
            .nav-links li:last-child a { border-bottom: none; }
            .risks-grid, .overview-grid, .innovation-components { grid-template-columns: 1fr; }
            .innovation-score { font-size: 3.5em; }
            .risk-header { flex-direction: column; align-items: flex-start; }
            .risk-metrics { grid-template-columns: 1fr; }
        }

        /* Enhanced Print Styles for Perfect PDF Export */
        @media print {
            /* Hide UI elements */
            .control-buttons, .success-message, .platform-container { 
                display: none !important; 
            }
            
            /* Optimize for A4 page */
            @page {
                size: A4;
                margin: 15mm 10mm;
            }
            
            /* Base layout fixes */
            body { 
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
                font-size: 12pt !important;
                line-height: 1.4 !important;
                background: white !important;
            }
            
            .report-container { 
                max-width: none !important; 
                box-shadow: none !important; 
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .container {
                max-width: none !important;
                margin: 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            
            /* Header adjustments */
            .header {
                padding: 30px 20px !important;
                margin-bottom: 20px !important;
                page-break-after: avoid !important;
            }
            
            .header h1 {
                font-size: 24pt !important;
                margin-bottom: 10px !important;
            }
            
            .header .subtitle {
                font-size: 14pt !important;
                margin-bottom: 8px !important;
            }
            
            .date-badge {
                font-size: 10pt !important;
                padding: 5px 12px !important;
            }
            
            /* Navigation - compact for print */
            .nav-menu { 
                position: static !important;
                page-break-after: avoid !important;
            }
            
            .nav-links {
                flex-wrap: wrap !important;
                font-size: 9pt !important;
            }
            
            .nav-links a {
                padding: 8px 10px !important;
                font-size: 9pt !important;
            }
            
            /* Section headers */
            .section-header {
                font-size: 18pt !important;
                padding: 15px 20px !important;
                margin: 15px 0 !important;
                page-break-after: avoid !important;
            }
            
            /* Project overview grid */
            .project-overview {
                padding: 20px !important;
                page-break-inside: avoid !important;
            }
            
            .overview-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
                margin-top: 15px !important;
            }
            
            .overview-card {
                padding: 15px !important;
                margin-bottom: 10px !important;
                page-break-inside: avoid !important;
                font-size: 11pt !important;
            }
            
            .overview-card h4 {
                font-size: 12pt !important;
                margin-bottom: 8px !important;
            }
            
            /* Goals and deliverables */
            .goals-section {
                margin: 15px 20px !important;
                padding: 15px !important;
                page-break-inside: avoid !important;
            }
            
            .goals-section h3 {
                font-size: 14pt !important;
                margin-bottom: 12px !important;
            }
            
            .goal-item, .deliverable-item {
                padding: 12px !important;
                margin: 8px 0 !important;
                font-size: 11pt !important;
                page-break-inside: avoid !important;
            }
            
            /* Risk management section */
            .risks-container {
                padding: 20px !important;
            }
            
            .risk-summary {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 20px !important;
                page-break-inside: avoid !important;
            }
            
            .summary-card {
                padding: 15px !important;
                font-size: 10pt !important;
            }
            
            .summary-number {
                font-size: 24pt !important;
                margin-bottom: 5px !important;
            }
            
            /* Risk cards - ensure they don't break across pages */
            .risks-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .risk-card {
                padding: 15px !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                font-size: 11pt !important;
            }
            
            .risk-title {
                font-size: 14pt !important;
                margin-bottom: 10px !important;
            }
            
            .risk-severity {
                font-size: 9pt !important;
                padding: 4px 8px !important;
            }
            
            .risk-metrics {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
                margin: 10px 0 !important;
            }
            
            .metric {
                padding: 8px !important;
            }
            
            .metric-value {
                font-size: 16pt !important;
            }
            
            .metric-label {
                font-size: 9pt !important;
            }
            
            .risk-description {
                padding: 12px !important;
                margin-top: 10px !important;
                font-size: 10pt !important;
                line-height: 1.3 !important;
            }
            
            .impact-list, .opportunity-list {
                margin: 8px 0 !important;
            }
            
            .impact-list li, .opportunity-list li {
                padding: 4px 0 !important;
                font-size: 10pt !important;
            }
            
            /* Strategies section */
            .strategies-section {
                padding: 20px !important;
            }
            
            .strategy-card {
                margin: 15px 0 !important;
                page-break-inside: avoid !important;
            }
            
            .strategy-header {
                padding: 15px 20px !important;
                font-size: 14pt !important;
            }
            
            .strategy-content {
                padding: 15px !important;
                font-size: 11pt !important;
            }
            
            .detail-item {
                padding: 10px !important;
                margin: 8px 0 !important;
                font-size: 10pt !important;
            }
            
            .timeline-badge {
                font-size: 8pt !important;
                padding: 3px 8px !important;
            }
            
            /* Innovation section */
            .innovation-section {
                padding: 20px !important;
                page-break-inside: avoid !important;
            }
            
            .innovation-score {
                font-size: 36pt !important;
                margin: 15px 0 !important;
            }
            
            .innovation-components {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }
            
            .component-card {
                padding: 15px !important;
                font-size: 11pt !important;
            }
            
            .component-score {
                font-size: 20pt !important;
                margin-bottom: 8px !important;
            }
            
            /* Regulation table */
            .regulation-section {
                padding: 20px !important;
            }
            
            .regulation-table {
                font-size: 10pt !important;
            }
            
            .regulation-table th,
            .regulation-table td {
                padding: 8px !important;
                font-size: 10pt !important;
            }
            
            /* Executive summary */
            .summary-box {
                padding: 15px !important;
                margin: 15px 0 !important;
                page-break-inside: avoid !important;
                font-size: 11pt !important;
            }
            
            .summary-box h3 {
                font-size: 16pt !important;
                margin-bottom: 12px !important;
            }
            
            .summary-box p {
                line-height: 1.4 !important;
                margin-bottom: 10px !important;
            }
            
            /* Recommendations */
            #recommendations ul li {
                font-size: 11pt !important;
                padding: 10px !important;
                margin-bottom: 8px !important;
                page-break-inside: avoid !important;
            }
            
            /* Footer */
            .footer {
                padding: 15px !important;
                font-size: 10pt !important;
                page-break-inside: avoid !important;
            }
            
            /* General page break rules */
            .section { 
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            h1, h2, h3, h4, h5 {
                page-break-after: avoid !important;
            }
            
            /* Force page breaks before major sections */
            #risks, #strategies, #innovation, #regulation-compliance, #executive-summary-section {
                page-break-before: auto !important;
            }
            
            /* Ensure colors print correctly */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        html { scroll-behavior: smooth; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>מעבד את המסמך...</h2>
            <p id="loadingStatus">מתחבר ל-Google Gemini AI...</p>
        </div>
    </div>

    <div class="success-message" id="successMessage"></div>

    <div class="control-buttons" id="controlButtons" style="display: none;">
        <button class="control-btn new-report-btn" onclick="showUploadStep()">📄 דוח חדש</button>
        <button class="control-btn edit-toggle" onclick="toggleEdit()">🎨 התחל עריכה</button>
        <button class="control-btn pdf-export" onclick="exportToPDF()">📄 ייצוא ל-PDF</button>
    </div>

    <!-- Step 1: API Setup & Upload -->
    <div class="platform-container" id="uploadStep">
        <div class="platform-header">
            <h1>🤖 RiskReportAI <span class="gemini-badge">Powered by Gemini</span></h1>
            <div class="subtitle">מחולל דוחות ניהול סיכונים חכם באמצעות AI</div>
        </div>

        <div class="api-setup" id="apiSetup">
            <h3>🔑 הגדרת מפתח API של Google Gemini</h3>
            <p>להפעלת המערכת, הכנס את מפתח ה-API של Gemini:</p>
            <div class="api-input-group">
                <input type="password" class="api-input" id="apiKeyInput" 
                       placeholder="AIza..." 
                       value="">
                <button class="api-button" onclick="saveAPIKey()">שמור מפתח</button>
            </div>
            <div class="api-status" id="apiStatus"></div>
        </div>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">📄</div>
            <h2 class="upload-title">העלה מסמך</h2>
            <p class="upload-subtitle">גרור קובץ לכאן או לחץ לבחירה</p>
            <input type="file" id="fileInput" accept=".docx,.pdf,.txt" style="display: none;" onchange="handleFileUpload(event)">
            <button class="upload-button">בחר קובץ</button>
            <div style="margin-top: 20px; color: #7f8c8d; font-size: 0.9em;">
                <small>תומך ב: Word (.docx), PDF, טקסט (.txt) - עד 16MB</small>
            </div>
        </div>

        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border-left: 4px solid #4285f4; margin-top: 30px; text-align: right;">
            <h3>🤖 איך זה עובד?</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="padding: 5px 0;">✅ Google Gemini AI מנתח את התוכן של המסמך שלך</li>
                <li style="padding: 5px 0;">✅ מזהה סיכונים, אתגרים והזדמנויות באופן אוטומטי</li>
                <li style="padding: 5px 0;">✅ מפה את המידע לתבנית דוח מקצועית</li>
                <li style="padding: 5px 0;">✅ יוצר דוח מעוצב עם אפשרות עריכה והורדה</li>
            </ul>
        </div>
    </div>

    <!-- Step 2: Processing -->
    <div class="platform-container processing-container" id="processingStep">
        <div style="text-align: center;">
            <h2>מעבד את המסמך שלך...</h2>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div style="margin: 30px 0;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="processing-steps">
                <div class="step" id="step1">
                    <div class="step-number">1</div>
                    <div>קורא קובץ...</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div>מנתח עם AI...</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div>יוצר דוח...</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div>הדוח מוכן!</div>
                </div>
            </div>
        </div>

        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border-left: 4px solid #4285f4; margin-top: 30px; text-align: right;">
            <h3>🔍 מה קורה מאחורי הקלעים?</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="padding: 5px 0;">🤖 Google Gemini AI מנתח את המסמך בעומק</li>
                <li style="padding: 5px 0;">📊 זיהוי אוטומטי של סיכונים ודירוגם</li>
                <li style="padding: 5px 0;">📋 מיפוי המידע לתבנית דוח מקצועית</li>
                <li style="padding: 5px 0;">🎨 יצירת דוח מעוצב עם כל הפרטים</li>
            </ul>
        </div>
    </div>

    <!-- Step 3: Report - EXACTLY MATCHING ORIGINAL -->
    <div class="report-container" id="reportStep">
        <div class="container">
            <header class="header">
                <h1 class="editable" id="reportTitle">דוח ניהול סיכונים מקיף</h1>
                <div class="subtitle editable" id="reportSubtitle">פרויקט 720 - טרנספורמציה דיגיטלית ללמידה מותאמת אישית</div>
                <div class="date-badge editable" id="reportBadge">משרד החינוך • מינהל חדשנות וטכנולוגיה • 2025</div>
            </header>

            <nav class="nav-menu">
                <ul class="nav-links">
                    <li><a href="#project" class="nav-link">📋 הגדרת הפרויקט</a></li>
                    <li><a href="#risks" class="nav-link">⚠️ ניהול סיכונים</a></li>
                    <li><a href="#strategies" class="nav-link">📈 תוכנית התמודדות</a></li>
                    <li><a href="#innovation" class="nav-link">🚀 אסדרת חדשנות</a></li>
                    <li><a href="#innovation-level" class="nav-link">📊 רמת החדשנות</a></li>
                    <li><a href="#regulation-compliance" class="nav-link">✅ התאמה לדרישות אסדרה</a></li>
                    <li><a href="#executive-summary-section" class="nav-link">📝 סיכום מנהלים והמלצות</a></li>
                </ul>
            </nav>

            <section id="project" class="section">
                <div class="section-header editable">📋 הגדרת הפרויקט</div>
                
                <div class="project-overview">
                    <h2 style="text-align: center; color: #2c3e50; font-size: 2.2em; margin-bottom: 30px;" class="editable">פרטי הפרויקט</h2>
                    <div class="overview-grid" id="projectOverview">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="goals-section">
                    <h3 class="editable">🎯 מטרות הפרויקט</h3>
                    <div id="projectGoals">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="goals-section">
                    <h3 class="editable">📋 תוצרים מצופים</h3>
                    <div id="projectDeliverables">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </section>

            <section id="risks" class="section">
                <div class="section-header editable">⚠️ ניהול סיכונים</div>
                
                <div class="risks-container">
                    <div class="risk-summary" id="riskSummary">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="risks-grid" id="risksGrid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </section>

            <section id="strategies" class="section">
                <div class="section-header editable">📈 תוכנית התמודדות עם סיכונים</div>
                <div class="strategies-section" id="strategiesSection">
                    <!-- Will be populated by JavaScript -->
                </div>
            </section>

            <section id="innovation" class="section">
                <div class="section-header editable">🚀 אסדרת חדשנות</div>
                <div class="risks-container">
                    <p class="editable" style="text-align: center; font-size: 1.1em; margin-bottom: 25px;">
                        הפרויקט נתפס כפרויקט חדשני בקנה מידה לאומי, המחייב בחינה מעמיקה של היבטים רגולטוריים ואסדרתיים כדי להבטיח את יישומו החלק והבטוח.
                    </p>
                    <div class="summary-box">
                        <h3 style="text-align: center; color: #2c3e50; font-size: 1.8em; margin-bottom: 20px;" class="editable">הגדרת רמת החדשנות</h3>
                        <p class="editable">
                            הפרויקט כולל אלמנטים של ביג דאטה, למידת מכונה (AI) והתאמה אישית בקנה מידה רחב, המחייבים בחינה מעמיקה של היבטים רגולטוריים ואסדרתיים.
                        </p>
                        <div class="committee-recommendations">
                            <h4><span class="icon">👥</span><span class="editable">המלצת ועדת המשנה לאסדרת חדשנות:</span></h4>
                            <p class="editable">
                                ועדת המשנה ממליצה לסווג את הפרויקט כ"<strong>חדשנות מהותית ורחבת היקף (Tier 1)</strong>". סיווג זה נובע מהפוטנציאל לשיבוש משמעותי במערכות הקיימות, היקף ההטמעה הארצי המתוכנן, והשימוש בטכנולוגיות מתקדמות בעלות השלכות רוחביות.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="innovation-level" class="section innovation-section">
                <div class="section-header editable">📊 רמת החדשנות בפרויקט</div>
                <p class="editable" style="font-size: 1.2em; max-width: 800px; margin: 20px auto 40px; color: rgba(255,255,255,0.9);">
                    רמת החדשנות של הפרויקט נמדדה על פי מספר קריטריונים, המשקפים את מידת ההשפעה, המורכבות הטכנולוגית והשינוי שהפרויקט מביא למערכת.
                </p>
                <div class="innovation-score editable">8.5 / 10</div>
                <div class="innovation-components">
                    <div class="component-card">
                        <div class="component-score editable">9.0</div>
                        <div class="component-title editable">השפעה פדגוגית</div>
                        <p class="editable">שינוי עמוק בתהליכי הוראה-למידה והתאמה אישית.</p>
                    </div>
                    <div class="component-card">
                        <div class="component-score editable">8.8</div>
                        <div class="component-title editable">מורכבות טכנולוגית</div>
                        <p class="editable">שילוב AI, למידת מכונה, ביג דאטה ואוטומציה.</p>
                    </div>
                    <div class="component-card">
                        <div class="component-score editable">8.2</div>
                        <div class="component-title editable">שינוי ארגוני</div>
                        <p class="editable">הטמעה רוחבית המשפיעה על כל רבדי המערכת.</p>
                    </div>
                    <div class="component-card">
                        <div class="component-score editable">8.0</div>
                        <div class="component-title editable">סיכון טכנולוגי</div>
                        <p class="editable">פיתוח ואינטגרציה של פתרונות חדשים.</p>
                    </div>
                </div>
            </section>

            <section id="regulation-compliance" class="section">
                <div class="section-header editable">✅ התאמה לדרישות אסדרה</div>
                <div class="regulation-section">
                    <p class="editable" style="font-size: 1.1em; text-align: center; margin-bottom: 30px;">
                        להלן פירוט ההתאמה של הפרויקט לדרישות האסדרה הרלוונטיות, וכן הפעולות הנדרשות להשלמת ההתאמה.
                    </p>
                    <div class="regulation-table">
                        <table>
                            <thead>
                                <tr>
                                    <th class="editable">דרישת אסדרה</th>
                                    <th class="editable">תיאור</th>
                                    <th class="editable">סטטוס התאמה</th>
                                    <th class="editable">פעולות נדרשות</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="editable">אבטחת מידע וסייבר</td>
                                    <td class="editable">הגנה על נתוני תלמידים ומורים מפני גישה בלתי מורשית.</td>
                                    <td class="editable" style="color: #fbbc04; font-weight: bold;">בבדיקה מתקדמת</td>
                                    <td class="editable">אישור סופי של ארכיטקטורת אבטחה.</td>
                                </tr>
                                <tr>
                                    <td class="editable">פרטיות מידע (GDPR)</td>
                                    <td class="editable">איסוף, אחסון ועיבוד נתונים בהתאם לרגולציה.</td>
                                    <td class="editable" style="color: #ea4335; font-weight: bold;">דורש התייחסות</td>
                                    <td class="editable">השלמת מסמך הערכת השפעה על פרטיות (PIA).</td>
                                </tr>
                                <tr>
                                    <td class="editable">הנגשה לבעלי מוגבלויות</td>
                                    <td class="editable">עמידה בתקני נגישות לווב (WCAG 2.1 AA).</td>
                                    <td class="editable" style="color: #34a853; font-weight: bold;">בתהליך אישור</td>
                                    <td class="editable">ביצוע סבב בדיקות נגישות אחרון.</td>
                                </tr>
                                <tr>
                                    <td class="editable">הטיית אלגוריתמים (AI Ethics)</td>
                                    <td class="editable">בחינה וצמצום הטיות אפשריות באלגוריתמי הלמידה.</td>
                                    <td class="editable" style="color: #ea4335; font-weight: bold;">דורש התייחסות</td>
                                    <td class="editable">הקמת ועדת אתיקה פנימית לבחינת האלגוריתמים.</td>
                                </tr>
                                <tr>
                                    <td class="editable">הכשרת עובדי הוראה</td>
                                    <td class="editable">עמידה בדרישות ההכשרה הפדגוגית והדיגיטלית.</td>
                                    <td class="editable" style="color: #34a853; font-weight: bold;">הושלם</td>
                                    <td class="editable">תיעוד ומעקב אחר השלמת ההכשרות.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="executive-summary-section" class="section">
                <div class="section-header editable">📝 סיכום מנהלים והמלצות</div>
                <div class="risks-container">
                    <div class="summary-box">
                        <h3 style="text-align: center; color: #2c3e50; font-size: 1.8em; margin-bottom: 25px;" class="editable">סיכום מנהלים</h3>
                        <p class="editable">
                            פרויקט הטרנספורמציה הדיגיטלית ללמידה מותאמת אישית מהווה יוזמה אסטרטגית משמעותית במערכת החינוך. הפרויקט שואף לשנות את פני החינוך בישראל באמצעות טכנולוגיות מתקדמות של בינה מלאכותית ולמידת מכונה.
                        </p>
                        <p class="editable">
                            <strong>נקודות חוזק מרכזיות:</strong> חזון ברור ומהפכני, תמיכה ארגונית רחבה, פוטנציאל השפעה עצום על מערכת החינוך.
                        </p>
                        <p class="editable">
                            <strong>אתגרים מרכזיים:</strong> מורכבות טכנולוגית גבוהה, התנגדות אפשרית לשינוי, דרישות רגולטוריות מחמירות, צורך בהשקעה משמעותית במשאבים.
                        </p>
                        <p class="editable">
                            <strong>סטטוס נוכחי:</strong> הפרויקט נמצא בשלב התכנון המתקדם, עם התקדמות משמעותית בהגדרת הארכיטקטורה הטכנולוגית והמודל הפדגוגי. נדרשת השלמת מספר אבני דרך רגולטוריות לפני תחילת הפיילוט.
                        </p>
                    </div>

                    <div class="summary-box" id="recommendations">
                        <h3 style="text-align: center; color: #2c3e50; font-size: 1.8em; margin-bottom: 25px;" class="editable">המלצות הוועדה</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #4caf50;">
                                <strong class="editable">1. אישור להמשך הפרויקט:</strong>
                                <span class="editable">מומלץ לאשר את המשך הפרויקט תוך הקפדה על עמידה בתוכנית ניהול הסיכונים המוצעת.</span>
                            </li>
                            <li style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #2196f3;">
                                <strong class="editable">2. הקמת ועדת היגוי ייעודית:</strong>
                                <span class="editable">להקים ועדת היגוי בהשתתפות נציגי הרגולטור, מומחי טכנולוגיה, אנשי חינוך ונציגי הורים.</span>
                            </li>
                            <li style="background: #fff3e0; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #ff9800;">
                                <strong class="editable">3. ביצוע פיילוט מבוקר:</strong>
                                <span class="editable">להתחיל בפיילוט מצומצם ב-10 בתי ספר לתקופה של 6 חודשים לפני הרחבה ארצית.</span>
                            </li>
                            <li style="background: #fce4ec; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #e91e63;">
                                <strong class="editable">4. תקצוב ייעודי:</strong>
                                <span class="editable">להקצות תקציב ייעודי של 50 מיליון ש"ח לשלב הפיילוט והערכות הראשונית.</span>
                            </li>
                            <li style="background: #f3e5f5; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #9c27b0;">
                                <strong class="editable">5. מעקב ובקרה רציפים:</strong>
                                <span class="editable">לקבוע מנגנון דיווח חודשי לוועדת ההיגוי ודיווח רבעוני להנהלת המשרד.</span>
                            </li>
                        </ul>
                    </div>

                    <div class="committee-recommendations">
                        <h4><span class="icon">📅</span><span class="editable">תאריך הדוח:</span></h4>
                        <p class="editable" id="reportDate">ינואר 2025</p>
                        <h4 style="margin-top: 20px;"><span class="icon">✍️</span><span class="editable">חתימת יו"ר הוועדה:</span></h4>
                        <p class="editable">____________________________</p>
                    </div>
                </div>
            </section>

            <footer class="footer">
                <p class="editable">© 2025 RiskReportAI - מערכת לניהול סיכונים בפרויקטים | Powered by Google Gemini AI</p>
            </footer>
        </div>
    </div>

    <script>
        // State Management
        let currentState = 'upload';
        let apiKey = '';
        let reportData = null;
        let isEditMode = false;

        // Check for saved API key
        window.onload = function() {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKeyInput').value = savedKey;
                showApiStatus('success', 'מפתח API נטען בהצלחה!');
                document.getElementById('uploadZone').classList.add('active');
            }
        };

        // API Key Management
        function saveAPIKey() {
            const keyInput = document.getElementById('apiKeyInput');
            const key = keyInput.value.trim();
            
            if (!key) {
                showApiStatus('error', 'נא להזין מפתח API');
                return;
            }
            
            if (!key.startsWith('AIza')) {
                showApiStatus('error', 'מפתח API לא תקין');
                return;
            }
            
            apiKey = key;
            localStorage.setItem('geminiApiKey', key);
            showApiStatus('success', 'מפתח API נשמר בהצלחה!');
            document.getElementById('uploadZone').classList.add('active');
        }

        function showApiStatus(type, message) {
            const status = document.getElementById('apiStatus');
            status.className = `api-status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
        }

        // File Upload Handling
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        async function handleFile(file) {
            if (!apiKey) {
                showApiStatus('error', 'נא להגדיר מפתח API תחילה');
                return;
            }

            const validTypes = ['.docx', '.pdf', '.txt'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(fileExtension)) {
                alert('נא לבחור קובץ Word, PDF או טקסט');
                return;
            }
            
            if (file.size > 16 * 1024 * 1024) {
                alert('הקובץ גדול מדי. מקסימום 16MB');
                return;
            }
            
            await processFile(file);
        }

        async function processFile(file) {
            // Show processing UI
            document.getElementById('uploadStep').style.display = 'none';
            document.getElementById('processingStep').classList.add('active');
            
            // Show file info
            document.getElementById('fileInfo').innerHTML = `
                <strong>קובץ:</strong> ${file.name}<br>
                <strong>גודל:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                <strong>סוג:</strong> ${file.type || 'לא ידוע'}
            `;
            
            // Simulate processing steps
            await simulateProcessing();
            
            // Extract text from file
            const text = await extractTextFromFile(file);
            
            if (!text) {
                alert('לא ניתן לקרוא את הקובץ');
                showUploadStep();
                return;
            }
            
            // Analyze with Gemini
            await analyzeWithGemini(text);
        }

        async function simulateProcessing() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            const progressFill = document.getElementById('progressFill');
            
            for (let i = 0; i < steps.length; i++) {
                const step = document.getElementById(steps[i]);
                step.classList.add('active');
                
                if (i > 0) {
                    document.getElementById(steps[i-1]).classList.remove('current');
                }
                
                step.classList.add('current');
                progressFill.style.width = ((i + 1) / steps.length * 100) + '%';
                
                // Update loading status
                const statusMessages = [
                    'קורא את הקובץ...',
                    'מנתח עם Google Gemini AI...',
                    'יוצר דוח מפורט...',
                    'הדוח מוכן!'
                ];
                document.getElementById('loadingStatus').textContent = statusMessages[i];
                
                if (i < steps.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
        }

        async function extractTextFromFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.txt')) {
                        resolve(content);
                    } else if (file.name.endsWith('.pdf')) {
                        // For demo purposes, we'll use a sample text
                        resolve(getSampleText());
                    } else if (file.name.endsWith('.docx')) {
                        // For demo purposes, we'll use a sample text
                        resolve(getSampleText());
                    } else {
                        resolve(null);
                    }
                };
                
                reader.onerror = function() {
                    resolve(null);
                };
                
                reader.readAsText(file);
            });
        }

        function getSampleText() {
            return `
                פרויקט 720 - טרנספורמציה דיגיטלית ללמידה מותאמת אישית
                
                משרד החינוך - מינהל חדשנות וטכנולוגיה
                
                תיאור הפרויקט:
                הפרויקט שואף ליצור מהפכה במערכת החינוך באמצעות פיתוח פלטפורמה דיגיטלית מתקדמת המבוססת על בינה מלאכותית ולמידת מכונה. הפלטפורמה תאפשר התאמה אישית של תהליכי הלמידה לכל תלמיד על פי יכולותיו, קצב הלמידה שלו ותחומי העניין האישיים.
                
                מטרות הפרויקט:
                1. יצירת סביבת למידה דיגיטלית אדפטיבית
                2. שיפור הישגי התלמידים באמצעות למידה מותאמת אישית
                3. הפחתת פערים לימודיים בין תלמידים
                4. פיתוח כלים למורים לניטור ומעקב אחר התקדמות התלמידים
                
                אתגרים וסיכונים:
                - מורכבות טכנולוגית גבוהה בפיתוח מערכת AI
                - התנגדות אפשרית של מורים לשינוי
                - דרישות אבטחת מידע ופרטיות מחמירות
                - עלויות פיתוח והטמעה גבוהות
                - צורך בהכשרה מקיפה של צוותי הוראה
            `;
        }

        async function analyzeWithGemini(text) {
            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('active');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `נתח את המסמך הבא וחלץ ממנו מידע ליצירת דוח ניהול סיכונים. 
                                זהה סיכונים, אתגרים, הזדמנויות ומידע רלוונטי אחר.
                                
                                המסמך:
                                ${text}
                                
                                החזר תשובה בפורמט JSON עם המבנה הבא:
                                {
                                    "projectName": "שם הפרויקט",
                                    "organization": "שם הארגון",
                                    "projectDetails": {
                                        "budget": "תקציב",
                                        "timeline": "לוח זמנים",
                                        "scope": "היקף",
                                        "team": "צוות"
                                    },
                                    "goals": ["מטרה 1", "מטרה 2"],
                                    "deliverables": ["תוצר 1", "תוצר 2"],
                                    "risks": [
                                        {
                                            "title": "כותרת הסיכון",
                                            "severity": "גבוה/בינוני/נמוך",
                                            "probability": 1-10,
                                            "impact": 1-10,
                                            "description": "תיאור",
                                            "mitigation": "אסטרטגיה להתמודדות"
                                        }
                                    ]
                                }`
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Gemini API error');
                }

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;
                
                // Try to parse as JSON
                try {
                    const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        reportData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found');
                    }
                } catch (e) {
                    // Use default data if parsing fails
                    reportData = getDefaultReportData();
                }
                
                // Generate report
                generateReport(reportData);
                
            } catch (error) {
                console.error('Gemini API Error:', error);
                // Use sample data for demo
                reportData = getDefaultReportData();
                generateReport(reportData);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function getDefaultReportData() {
            return {
                projectName: "פרויקט 720 - טרנספורמציה דיגיטלית ללמידה מותאמת אישית",
                organization: "משרד החינוך - מינהל חדשנות וטכנולוגיה",
                projectDetails: {
                    budget: "120 מיליון ש״ח",
                    timeline: "36 חודשים",
                    scope: "כלל מערכת החינוך - 4,800 בתי ספר",
                    team: "150 אנשי צוות"
                },
                goals: [
                    "יצירת פלטפורמה דיגיטלית אדפטיבית ללמידה מותאמת אישית",
                    "שיפור הישגי הלמידה ב-25% תוך 3 שנים",
                    "הפחתת פערים לימודיים בין תלמידים ב-30%",
                    "פיתוח כלי ניטור ומעקב מתקדמים למורים"
                ],
                deliverables: [
                    "פלטפורמת למידה דיגיטלית מבוססת AI",
                    "מערכת ניהול תוכן לימודי אדפטיבית",
                    "לוח בקרה למורים ומנהלים",
                    "אפליקציה לתלמידים והורים"
                ],
                risks: [
                    {
                        title: "מורכבות טכנולוגית בפיתוח מערכת AI",
                        severity: "גבוה מאוד",
                        probability: 8,
                        impact: 9,
                        risk: 72,
                        description: "פיתוח אלגוריתמים של למידת מכונה להתאמה אישית דורש מומחיות גבוהה וזמן פיתוח ארוך.",
                        impacts: [
                            "עיכוב בלוחות הזמנים של הפרויקט",
                            "חריגה מהתקציב המתוכנן",
                            "אי עמידה בדרישות הפונקציונליות"
                        ],
                        opportunities: [
                            "שיתוף פעולה עם אוניברסיטאות מובילות",
                            "גיוס מומחי AI בינלאומיים",
                            "שימוש בטכנולוגיות קוד פתוח"
                        ]
                    },
                    {
                        title: "התנגדות צוותי הוראה לשינוי",
                        severity: "גבוה",
                        probability: 7,
                        impact: 8,
                        risk: 56,
                        description: "מורים עלולים לחשוש מאיבוד מקום עבודה או משינוי דרסטי בשיטות ההוראה.",
                        impacts: [
                            "התנגדות אקטיבית להטמעת המערכת",
                            "שימוש חלקי בלבד ביכולות המערכת",
                            "פגיעה במוטיבציה של הצוות החינוכי"
                        ],
                        opportunities: [
                            "הכשרות מקיפות ותמיכה רציפה",
                            "תמריצים למורים מובילים",
                            "שיתוף המורים בתהליך הפיתוח"
                        ]
                    },
                    {
                        title: "אתגרי אבטחת מידע ופרטיות",
                        severity: "גבוה מאוד",
                        probability: 6,
                        impact: 10,
                        risk: 60,
                        description: "המערכת תכיל מידע רגיש על מיליוני תלמידים, מה שמציב אתגרי אבטחה משמעותיים.",
                        impacts: [
                            "סיכון לדליפת מידע רגיש",
                            "תביעות משפטיות אפשריות",
                            "פגיעה באמון הציבור"
                        ],
                        opportunities: [
                            "הטמעת תקני אבטחה מתקדמים",
                            "שיתוף פעולה עם מערך הסייבר הלאומי",
                            "פיתוח מודל אבטחה חדשני לחינוך"
                        ]
                    },
                    {
                        title: "תקציב ומשאבים מוגבלים",
                        severity: "בינוני",
                        probability: 6,
                        impact: 7,
                        risk: 42,
                        description: "קיצוצים תקציביים אפשריים עלולים להשפיע על היקף הפרויקט.",
                        impacts: [
                            "צמצום היקף הפרויקט",
                            "דחיית שלבי הטמעה",
                            "ויתור על פיצ'רים חשובים"
                        ],
                        opportunities: [
                            "גיוס תרומות ממגזר פרטי",
                            "שותפויות אסטרטגיות עם חברות טכנולוגיה",
                            "מודל הטמעה מדורג וחסכוני"
                        ]
                    }
                ]
            };
        }

        function generateReport(data) {
            // Update header
            document.getElementById('reportTitle').textContent = 'דוח ניהול סיכונים מקיף';
            document.getElementById('reportSubtitle').textContent = data.projectName;
            document.getElementById('reportBadge').textContent = `${data.organization} • ${new Date().getFullYear()}`;
            
            // Update project overview
            const overviewGrid = document.getElementById('projectOverview');
            overviewGrid.innerHTML = `
                <div class="overview-card">
                    <h4><span class="icon">💰</span>תקציב הפרויקט</h4>
                    <p class="editable">${data.projectDetails.budget}</p>
                </div>
                <div class="overview-card">
                    <h4><span class="icon">📅</span>לוח זמנים</h4>
                    <p class="editable">${data.projectDetails.timeline}</p>
                </div>
                <div class="overview-card">
                    <h4><span class="icon">🎯</span>היקף הפרויקט</h4>
                    <p class="editable">${data.projectDetails.scope}</p>
                </div>
                <div class="overview-card">
                    <h4><span class="icon">👥</span>צוות הפרויקט</h4>
                    <p class="editable">${data.projectDetails.team}</p>
                </div>
            `;
            
            // Update goals
            const goalsDiv = document.getElementById('projectGoals');
            goalsDiv.innerHTML = data.goals.map(goal => 
                `<div class="goal-item editable">${goal}</div>`
            ).join('');
            
            // Update deliverables
            const deliverablesDiv = document.getElementById('projectDeliverables');
            deliverablesDiv.innerHTML = data.deliverables.map(deliverable => 
                `<div class="deliverable-item editable">${deliverable}</div>`
            ).join('');
            
            // Update risk summary
            const riskCounts = {
                'גבוה מאוד': 0,
                'גבוה': 0,
                'בינוני': 0,
                'נמוך': 0
            };
            
            data.risks.forEach(risk => {
                riskCounts[risk.severity] = (riskCounts[risk.severity] || 0) + 1;
            });
            
            const summaryDiv = document.getElementById('riskSummary');
            summaryDiv.innerHTML = `
                <div class="summary-card">
                    <div class="summary-number very-high">${riskCounts['גבוה מאוד']}</div>
                    <div>סיכונים גבוהים מאוד</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number high">${riskCounts['גבוה']}</div>
                    <div>סיכונים גבוהים</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number medium">${riskCounts['בינוני']}</div>
                    <div>סיכונים בינוניים</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number low">${riskCounts['נמוך']}</div>
                    <div>סיכונים נמוכים</div>
                </div>
            `;
            
            // Update risks grid
            const risksGrid = document.getElementById('risksGrid');
            risksGrid.innerHTML = data.risks.map(risk => {
                const severityClass = {
                    'גבוה מאוד': 'risk-very-high',
                    'גבוה': 'risk-high',
                    'בינוני': 'risk-medium',
                    'נמוך': 'risk-low'
                }[risk.severity] || 'risk-medium';
                
                const severityBadgeClass = {
                    'גבוה מאוד': 'severity-very-high',
                    'גבוה': 'severity-high',
                    'בינוני': 'severity-medium',
                    'נמוך': 'severity-low'
                }[risk.severity] || 'severity-medium';
                
                return `
                    <div class="risk-card ${severityClass}">
                        <div class="risk-header">
                            <h3 class="risk-title editable">${risk.title}</h3>
                            <span class="risk-severity ${severityBadgeClass} editable">${risk.severity}</span>
                        </div>
                        <div class="risk-metrics">
                            <div class="metric">
                                <div class="metric-value editable">${risk.probability}</div>
                                <div class="metric-label">סבירות</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value editable">${risk.impact}</div>
                                <div class="metric-label">השפעה</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value editable">${risk.risk}</div>
                                <div class="metric-label">ציון סיכון</div>
                            </div>
                        </div>
                        <div class="risk-description editable">${risk.description}</div>
                        ${risk.impacts ? `
                            <div class="risk-impact">
                                <div class="impact-title">השפעות אפשריות:</div>
                                <ul class="impact-list">
                                    ${risk.impacts.map(impact => `<li class="editable">${impact}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${risk.opportunities ? `
                            <div>
                                <div class="opportunity-title">הזדמנויות:</div>
                                <ul class="opportunity-list">
                                    ${risk.opportunities.map(opp => `<li class="editable">${opp}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // Generate strategies
            generateStrategies(data.risks);
            
            // Update report date
            const today = new Date();
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            document.getElementById('reportDate').textContent = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
            
            // Show report
            showReport();
        }

        function generateStrategies(risks) {
            const strategiesSection = document.getElementById('strategiesSection');
            
            const strategies = [
                {
                    title: "אסטרטגיית הפחתת סיכונים טכנולוגיים",
                    items: [
                        {
                            title: "גיוס מומחים",
                            desc: "גיוס צוות מומחי AI ולמידת מכונה בעלי ניסיון מוכח",
                            timeline: "מיידי"
                        },
                        {
                            title: "שותפויות אקדמיות",
                            desc: "יצירת שיתופי פעולה עם מוסדות אקדמיים מובילים",
                            timeline: "תוך 3 חודשים"
                        },
                        {
                            title: "פיילוט מדורג",
                            desc: "הרצת פיילוט מצומצם לבדיקת הטכנולוגיה",
                            timeline: "תוך 6 חודשים"
                        }
                    ]
                },
                {
                    title: "תוכנית ניהול שינוי והכשרות",
                    items: [
                        {
                            title: "סדנאות הכנה",
                            desc: "הרצת סדנאות הכנה למורים ומנהלים",
                            timeline: "לפני ההטמעה"
                        },
                        {
                            title: "מורים מובילים",
                            desc: "הכשרת מורים מובילים כשגרירי השינוי",
                            timeline: "תוך 4 חודשים"
                        },
                        {
                            title: "תמיכה מתמשכת",
                            desc: "הקמת מערך תמיכה 24/7 למורים",
                            timeline: "עם תחילת ההטמעה"
                        }
                    ]
                },
                {
                    title: "מערך אבטחת מידע מתקדם",
                    items: [
                        {
                            title: "תשתית מאובטחת",
                            desc: "בניית תשתית ענן מאובטחת בתקני ISO 27001",
                            timeline: "תוך 3 חודשים"
                        },
                        {
                            title: "הצפנה מלאה",
                            desc: "הטמעת הצפנה מקצה לקצה לכל המידע",
                            timeline: "מיידי"
                        },
                        {
                            title: "ביקורות אבטחה",
                            desc: "ביצוע ביקורות אבטחה רבעוניות",
                            timeline: "מתמשך"
                        }
                    ]
                }
            ];
            
            strategiesSection.innerHTML = strategies.map(strategy => `
                <div class="strategy-card">
                    <div class="strategy-header editable">${strategy.title}</div>
                    <div class="strategy-content">
                        <div class="strategy-detail">
                            ${strategy.items.map(item => `
                                <div class="detail-item">
                                    <h5 class="editable">${item.title}</h5>
                                    <p class="editable">${item.desc}</p>
                                    <span class="timeline-badge editable">${item.timeline}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showReport() {
            // Hide processing
            document.getElementById('processingStep').classList.remove('active');
            
            // Show report
            document.getElementById('reportStep').classList.add('active');
            document.getElementById('controlButtons').style.display = 'flex';
            
            // Initialize navigation
            initializeNavigation();
            
            // Show success message
            showSuccessMessage('הדוח נוצר בהצלחה! 🎉\nכעת תוכל לערוך ולייצא את הדוח');
        }

        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Smooth scroll to section
                    const targetId = this.getAttribute('href');
                    const targetSection = document.querySelector(targetId);
                    
                    if (targetSection) {
                        targetSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Highlight active section on scroll
            window.addEventListener('scroll', function() {
                let current = '';
                const sections = document.querySelectorAll('.section');
                
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    const sectionHeight = section.clientHeight;
                    
                    if (window.pageYOffset >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });
                
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#' + current) {
                        link.classList.add('active');
                    }
                });
            });
        }

        function toggleEdit() {
            isEditMode = !isEditMode;
            const editBtn = document.querySelector('.edit-toggle');
            const editables = document.querySelectorAll('.editable');
            
            if (isEditMode) {
                editBtn.classList.add('active');
                editBtn.innerHTML = '✅ סיים עריכה';
                editables.forEach(el => {
                    el.setAttribute('contenteditable', 'true');
                });
                showSuccessMessage('מצב עריכה הופעל ✏️\nלחץ על כל טקסט כדי לערוך');
            } else {
                editBtn.classList.remove('active');
                editBtn.innerHTML = '🎨 התחל עריכה';
                editables.forEach(el => {
                    el.setAttribute('contenteditable', 'false');
                });
                showSuccessMessage('העריכה הסתיימה ונשמרה ✅');
            }
        }

        async function exportToPDF() {
            const exportBtn = document.querySelector('.pdf-export');
            exportBtn.classList.add('exporting');
            exportBtn.innerHTML = '⏳ מייצא...';
            exportBtn.disabled = true;
            
            // End edit mode if active
            if (isEditMode) {
                toggleEdit();
            }
            
            showSuccessMessage('מכין את הקובץ להורדה... ⏳');
            
            // Wait a moment for UI to update
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Use browser's print functionality
            window.print();
            
            // Reset button
            setTimeout(() => {
                exportBtn.classList.remove('exporting');
                exportBtn.innerHTML = '📄 ייצוא ל-PDF';
                exportBtn.disabled = false;
                showSuccessMessage('הדוח מוכן להורדה! 📄\nבחר "Save as PDF" בחלון ההדפסה');
            }, 1000);
        }

        function showUploadStep() {
            document.getElementById('uploadStep').style.display = 'block';
            document.getElementById('processingStep').classList.remove('active');
            document.getElementById('reportStep').classList.remove('active');
            document.getElementById('controlButtons').style.display = 'none';
            
            // Reset file input
            document.getElementById('fileInput').value = '';
        }

        function showSuccessMessage(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.classList.add('show');
            
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
